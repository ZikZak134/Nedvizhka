# –ü—Ä–∞–≤–∏–ª–∞ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã API (API Rules)

## üìÅ –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å
–§–∞–π–ª: **`.agent/rules/api.md`**
–°—Ç–µ–∫: **FastAPI (Python)**
–ü—Ä–∏–Ω—Ü–∏–ø: **Resource-Oriented Design (AIP style)**

---

## 1. –ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏ —Ä–µ—Å—É—Ä—Å–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω
–ú—ã —Å—Ç—Ä–æ–∏–º API –≤–æ–∫—Ä—É–≥ **—Ä–µ—Å—É—Ä—Å–æ–≤** (—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö), –∞ –Ω–µ –¥–µ–π—Å—Ç–≤–∏–π. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞.

### –ü—Ä–∏–Ω—Ü–∏–ø—ã
- **–†–µ—Å—É—Ä—Å—ã:** `properties`, `districts`, `reports`.
- **–ò–µ—Ä–∞—Ä—Ö–∏—è:** `/v1/districts/{district_id}/properties/{property_id}`.
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã:** –ò—Å–ø–æ–ª—å–∑—É–µ–º `List`, `Get`, `Create`, `Update`, `Delete` –∫–∞–∫ –±–∞–∑—É.
- **Custom-–º–µ—Ç–æ–¥—ã:** –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç `/resource/{id}:customAction` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/properties/123:publish`).

---

## 2. –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (PATCH, ETag, –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å)

### –ß–∞—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (PATCH)
–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ `PATCH` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `update_mask` (field mask).
- –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—á–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ `price`, –Ω–µ —Ç—Ä–æ–≥–∞—è `description`).
- –ë—ç–∫–µ–Ω–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç **—Ç–æ–ª—å–∫–æ** —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ –º–∞—Å–∫–µ –ø–æ–ª—è.

### –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ ETag
–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —á—É–∂–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø—Ä–æ–±–ª–µ–º–∞ "Lost Update").
1. **GET** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `ETag: "hash-version-1"`.
2. **PATCH/PUT** –∫–ª–∏–µ–Ω—Ç –æ–±—è–∑–∞–Ω –ø—Ä–∏—Å–ª–∞—Ç—å `If-Match: "hash-version-1"`.
3. –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —É–∂–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `412 Precondition Failed`.

### –£—Å–ª–æ–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
–î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º `If-None-Match`. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `304 Not Modified` –±–µ–∑ —Ç–µ–ª–∞ –æ—Ç–≤–µ—Ç–∞.

---

## 3. –°–ø–∏—Å–∫–∏ –∏ –ü–∞–≥–∏–Ω–∞—Ü–∏—è (Pagination as a Product)
–ù–∏–∫–∞–∫–∏—Ö `offset/limit`. –¢–æ–ª—å–∫–æ **Token-based pagination**.

### –°—Ç–∞–Ω–¥–∞—Ä—Ç List Request:
```python
page_size: int = 50   # –°–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–µ—Ä–Ω—É—Ç—å
page_token: str = ""  # –¢–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (cursor)
filter: str = ""      # –°—Ç—Ä–æ–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (DSL)
```

### –°—Ç–∞–Ω–¥–∞—Ä—Ç List Response:
```json
{
  "properties": [...],           // –ú–∞—Å—Å–∏–≤ —Ä–µ—Å—É—Ä—Å–æ–≤
  "next_page_token": "abc...",   // –¢–æ–∫–µ–Ω –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  "total_size": 142              // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±—â–µ–µ –∫–æ–ª-–≤–æ
}
```
**–ü–æ—á–µ–º—É:** Offset-–ø–∞–≥–∏–Ω–∞—Ü–∏—è "–ø–ª—ã–≤–µ—Ç" –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏ –º–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –¢–æ–∫–µ–Ω—ã —Å—Ç–∞–±–∏–ª—å–Ω—ã –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã.

---

## 4. –û—à–∏–±–∫–∏ –∏ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å (Error Handling)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (RFC 7807)
–í—Å–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ `application/problem+json`.
```json
{
  "type": "https://api.domain.com/errors/resource-exhausted",
  "title": "Rate Limit Exceeded",
  "status": 429,
  "detail": "Quota exceeded list_properties request.",
  "instance": "/v1/properties",
  "retry_after": 60
}
```

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (Idempotency-Key)
–î–ª—è `POST` –∏ `PATCH` –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Idempotency-Key`.
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º (–∏–∑-–∑–∞ —Ä–∞–∑—Ä—ã–≤–∞ —Å–µ—Ç–∏), —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –ø–æ–≤—Ç–æ—Ä–Ω–æ, –∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–≤–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

### Rate Limiting & Retries
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `429 Too Many Requests`.
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Retry-After: <seconds>`, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –∑–Ω–∞–ª, –∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å.

---

## 5. –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è API Endpoint
- [ ] **URL:** –°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ? (`/properties`)
- [ ] **Method:** –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π HTTP –≥–ª–∞–≥–æ–ª? (GET, POST, PATCH)
- [ ] **Response:** DTO –º–æ–¥–µ–ª—å (–Ω–µ ORM)?
- [ ] **Errors:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ProblemDetail` —ç–∫—Å–µ–ø—à–µ–Ω—ã?
