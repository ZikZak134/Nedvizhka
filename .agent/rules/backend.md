# –ü—Ä–∞–≤–∏–ª–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±—ç–∫–µ–Ω–¥–∞ (Backend Rules)

## üìÅ –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å
–§–∞–π–ª: **`.agent/rules/backend.md`**
–°—Ç–µ–∫: **FastAPI, PostgreSQL (TimescaleDB), Redis, Celery**
–ü–∞—Ç—Ç–µ—Ä–Ω: **Clean Architecture (Layered), 12-Factor App**

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ì—Ä–∞–Ω–∏—Ü—ã ("–°–ª–æ–µ–Ω—ã–π –ø–∏—Ä–æ–≥")
–ú—ã —Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–¥–µ–ª—è–µ–º –∫–æ–¥ –Ω–∞ —Å–ª–æ–∏, —á—Ç–æ–±—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ –∑–∞–≤–∏—Å–µ–ª–∞ –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ –∏–ª–∏ –ë–î.

### –°–ª–æ–∏
1.  **Transport (Interface)**: FastAPI Routers, Pydantic Schemas. –ó–Ω–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–∞–∫ –ø—Ä–∏–Ω—è—Ç—å HTTP –∏ –≤—ã–∑–≤–∞—Ç—å Use Case. –ù–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ ORM.
2.  **Application (Use Cases)**: –ë–∏–∑–Ω–µ—Å-—Å—Ü–µ–Ω–∞—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `PublishProperty`). –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (UnitOfWork).
3.  **Domain**: –ß–∏—Å—Ç—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞ (Entities). –ù–∏–∫–∞–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
4.  **Infrastructure**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ (SQLAlchemy), –∞–¥–∞–ø—Ç–µ—Ä—ã –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º (S3, Redis).

### Unit of Work (UoW)
–û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å = –û–¥–∏–Ω "–ê—Ç–æ–º–∞—Ä–Ω—ã–π –Æ–Ω–∏—Ç".
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω **UnitOfWork**: –≤–Ω–µ–¥—Ä—è–µ–º –µ–≥–æ –≤ Use Case.
- `commit()`/`rollback()` –≤—ã–∑—ã–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –≤ —Å–ª–æ–µ Application –∏–ª–∏ Middleware, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö.

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª (Lifespan)
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DB –ø—É–ª–æ–≤, Redis –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ ML –º–æ–¥–µ–ª–µ–π ‚Äî —Å—Ç—Ä–æ–≥–æ —á–µ—Ä–µ–∑ `lifespan` (context manager).
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∑–∞–ø—Ä–µ—â–µ–Ω—ã. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

## 2. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å

### –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (BackgroundTasks)
- –õ–µ–≥–∫–∏–µ –∑–∞–¥–∞—á–∏ (–æ—Ç–ø—Ä–∞–≤–∫–∞ email, update –º–µ—Ç—Ä–∏–∫–∏) –¥–µ–ª–∞–µ–º —á–µ—Ä–µ–∑ `BackgroundTasks` –≤ FastAPI. –û–Ω–∏ —Å—Ç–∞—Ä—Ç—É—é—Ç **–ø–æ—Å–ª–µ** –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É (200 OK).
- –¢—è–∂–µ–ª—ã–µ –∑–∞–¥–∞—á–∏ (–ø–∞—Ä—Å–∏–Ω–≥, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF) ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ **Celery**.

### Transactional Outbox (–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞)
–î–ª—è —Å–æ–±—ã—Ç–∏–π, –∫–æ—Ç–æ—Ä—ã–µ **–æ–±—è–∑–∞–Ω—ã** —É–π—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞"):
1. –í —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î –ø–∏—à–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—É `outbox`.
2. Commit —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
3. –û—Ç–¥–µ–ª—å–Ω—ã–π Debezium/Polling –≤–æ—Ä–∫–µ—Ä —á–∏—Ç–∞–µ—Ç `outbox` –∏ –ø—É—à–∏—Ç –≤ –æ—á–µ—Ä–µ–¥—å.

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (Create Order, Payment) –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å `idempotency_key`.
- –õ–æ–≥–∏–∫–∞: "–ï—Å–ª–∏ –∫–ª—é—á –µ—Å—Ç—å –≤ Redis ‚Äî –≤–µ—Ä–Ω–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤—ã–ø–æ–ª–Ω—è–π".

---

## 3. –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å (Observability)

### Structured Logging (JSON)
- –ü–∏—à–µ–º –≤ `stdout` –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è**: `level`, `timestamp`, `message`, `trace_id`, `request_id`.
- **Latency**: –õ–æ–≥–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (`latency_ms`) –≤ middleware.

### Correlation ID
1. Middleware —á–∏—Ç–∞–µ—Ç (–∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ç) –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Request-Id`.
2. –ö–ª–∞–¥–µ—Ç –µ–≥–æ –≤ `contextvars`.
3. –õ–æ–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ **–∫–∞–∂–¥—É—é** –∑–∞–ø–∏—Å—å –ª–æ–≥–∞.

---

## 4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö

### Session Security
- **–ù–∏–∫–æ–≥–¥–∞** –Ω–µ –ª–æ–≥–∏—Ä—É–µ–º —Å—ã—Ä—ã–µ `session_id`, `token`, `password`.
- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–ª–∞–¥–∏—Ç—å —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–æ–≥–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º **Salted Hash** –æ—Ç ID —Å–µ—Å—Å–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è OWASP).

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **–í–Ω–µ—à–Ω–∏–µ –æ—à–∏–±–∫–∏ (4xx)**: –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `ErrorCode` (—Å—Ç—Ä–æ–∫–∞) + –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
- **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—à–∏–±–∫–∏ (500)**: –ö–ª–∏–µ–Ω—Ç—É ‚Äî "Internal Server Error" + `request_id`. –í –ª–æ–≥–∏ ‚Äî –ø–æ–ª–Ω—ã–π traceback —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
